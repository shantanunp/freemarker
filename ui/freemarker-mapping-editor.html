<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeMarker Mapping Visual Editor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .mapping-row {
            transition: all 0.2s ease;
        }
        .mapping-row:hover {
            background-color: #f8fafc;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Sample FreeMarker template for demo
        const sampleTemplate = `{
  "customerId": "\${customer.id}",
  "fullName": "\${customer.firstName} \${customer.lastName}",
  "email": "\${customer.email}",
  "phone": "\${customer.phoneNumber}",
  "address": {
    "street": "\${customer.address.street}",
    "city": "\${customer.address.city}",
    "state": "\${customer.address.state}",
    "zipCode": "\${customer.address.zipCode}"
  },
  "accountType": "\${customer.accountType}",
  "status": "\${customer.status}",
  "joinDate": "\${customer.createdDate}"
}`;

        function FreemarkerEditor() {
            const [step, setStep] = useState(1);
            const [templateContent, setTemplateContent] = useState('');
            const [mappings, setMappings] = useState([]);
            const [originalMappings, setOriginalMappings] = useState([]);
            const [editingIndex, setEditingIndex] = useState(null);
            const [outputFormat, setOutputFormat] = useState('json');

            // Parse FreeMarker template to extract mappings
            const parseTemplate = (content) => {
                const mappingList = [];
                const regex = /"([^"]+)":\s*"\$\{([^}]+)\}"/g;
                let match;

                while ((match = regex.exec(content)) !== null) {
                    const targetField = match[1];
                    const sourceField = match[2];
                    
                    mappingList.push({
                        id: Date.now() + Math.random(),
                        target: targetField,
                        source: sourceField,
                        transformation: 'direct',
                        description: '',
                        isNew: false
                    });
                }

                setMappings([...mappingList]);
                setOriginalMappings(JSON.parse(JSON.stringify(mappingList)));
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const content = event.target.result;
                        setTemplateContent(content);
                        parseTemplate(content);
                    };
                    reader.readAsText(file);
                }
            };

            const handleLoadSample = () => {
                setTemplateContent(sampleTemplate);
                parseTemplate(sampleTemplate);
            };

            const updateMapping = (index, field, value) => {
                const newMappings = [...mappings];
                newMappings[index][field] = value;
                setMappings(newMappings);
            };

            const addNewMapping = () => {
                const newMapping = {
                    id: Date.now(),
                    target: '',
                    source: '',
                    transformation: 'direct',
                    description: '',
                    isNew: true
                };
                setMappings([...mappings, newMapping]);
                setEditingIndex(mappings.length);
            };

            const deleteMapping = (index) => {
                const newMappings = mappings.filter((_, i) => i !== index);
                setMappings(newMappings);
            };

            const getChanges = () => {
                const changes = {
                    modified: [],
                    added: [],
                    deleted: []
                };

                // Find added mappings
                mappings.forEach(mapping => {
                    if (mapping.isNew) {
                        changes.added.push(mapping);
                    } else {
                        const original = originalMappings.find(m => m.id === mapping.id);
                        if (original && (original.target !== mapping.target || original.source !== mapping.source)) {
                            changes.modified.push({
                                original,
                                updated: mapping
                            });
                        }
                    }
                });

                // Find deleted mappings
                originalMappings.forEach(original => {
                    if (!mappings.find(m => m.id === original.id)) {
                        changes.deleted.push(original);
                    }
                });

                return changes;
            };

            const generateV2Template = () => {
                let template = '{\n';
                
                mappings.forEach((mapping, index) => {
                    const indent = '  ';
                    const isLast = index === mappings.length - 1;
                    
                    if (mapping.transformation === 'direct') {
                        template += `${indent}"${mapping.target}": "\${${mapping.source}}"${isLast ? '' : ','}\n`;
                    } else if (mapping.transformation === 'concatenate') {
                        template += `${indent}"${mapping.target}": "\${${mapping.source}}"${isLast ? '' : ','}\n`;
                    } else if (mapping.transformation === 'conditional') {
                        template += `${indent}"${mapping.target}": "<#if ${mapping.source}??>\${${mapping.source}}<#else>N/A</#if>"${isLast ? '' : ','}\n`;
                    }
                });
                
                template += '}';
                return template;
            };

            const downloadTemplate = () => {
                const v2Template = generateV2Template();
                const blob = new Blob([v2Template], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'customer-transform-v2.ftl';
                a.click();
                URL.revokeObjectURL(url);
            };

            // Step 1: Upload Template
            const Step1 = () => (
                <div className="bg-white rounded-lg shadow-lg p-8 max-w-4xl mx-auto">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Upload FreeMarker Template</h2>
                    
                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                        </svg>
                        
                        <input
                            type="file"
                            accept=".ftl"
                            onChange={handleFileUpload}
                            className="hidden"
                            id="file-upload"
                        />
                        <label htmlFor="file-upload" className="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                            Choose FreeMarker Template (.ftl)
                        </label>
                        
                        <p className="mt-4 text-sm text-gray-500">or</p>
                        
                        <button
                            onClick={handleLoadSample}
                            className="mt-2 inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                        >
                            Load Sample Template
                        </button>
                    </div>

                    {templateContent && (
                        <div className="mt-6">
                            <h3 className="text-lg font-semibold text-gray-700 mb-2">Preview:</h3>
                            <pre className="bg-gray-50 border border-gray-200 rounded p-4 text-xs overflow-x-auto custom-scrollbar max-h-96">
                                {templateContent}
                            </pre>
                            
                            <button
                                onClick={() => setStep(2)}
                                className="mt-4 w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold"
                            >
                                Next: Edit Mappings
                            </button>
                        </div>
                    )}
                </div>
            );

            // Step 2: Edit Mappings
            const Step2 = () => {
                const changes = getChanges();
                
                return (
                    <div className="bg-white rounded-lg shadow-lg p-8 max-w-6xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">Edit Field Mappings</h2>
                            <div className="flex gap-2">
                                <button
                                    onClick={addNewMapping}
                                    className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Mapping
                                </button>
                            </div>
                        </div>

                        <div className="mb-4 flex items-center gap-4 bg-blue-50 p-4 rounded-lg">
                            <svg className="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                            </svg>
                            <div className="text-sm text-gray-700">
                                <strong>{mappings.length}</strong> mappings found. 
                                {changes.modified.length > 0 && <span className="ml-2 text-amber-700"><strong>{changes.modified.length}</strong> modified</span>}
                                {changes.added.length > 0 && <span className="ml-2 text-green-700"><strong>{changes.added.length}</strong> added</span>}
                            </div>
                        </div>

                        <div className="overflow-x-auto custom-scrollbar">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target Field</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source Field</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transformation</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {mappings.map((mapping, index) => (
                                        <tr key={mapping.id} className={`mapping-row ${mapping.isNew ? 'bg-green-50' : ''}`}>
                                            <td className="px-6 py-4">
                                                <input
                                                    type="text"
                                                    value={mapping.target}
                                                    onChange={(e) => updateMapping(index, 'target', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    placeholder="e.g., customerId"
                                                />
                                            </td>
                                            <td className="px-6 py-4">
                                                <input
                                                    type="text"
                                                    value={mapping.source}
                                                    onChange={(e) => updateMapping(index, 'source', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    placeholder="e.g., customer.id"
                                                />
                                            </td>
                                            <td className="px-6 py-4">
                                                <select
                                                    value={mapping.transformation}
                                                    onChange={(e) => updateMapping(index, 'transformation', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                >
                                                    <option value="direct">Direct</option>
                                                    <option value="concatenate">Concatenate</option>
                                                    <option value="conditional">Conditional</option>
                                                </select>
                                            </td>
                                            <td className="px-6 py-4">
                                                <input
                                                    type="text"
                                                    value={mapping.description}
                                                    onChange={(e) => updateMapping(index, 'description', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                    placeholder="Optional description"
                                                />
                                            </td>
                                            <td className="px-6 py-4">
                                                <button
                                                    onClick={() => deleteMapping(index)}
                                                    className="text-red-600 hover:text-red-800"
                                                    title="Delete mapping"
                                                >
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="mt-6 flex justify-between">
                            <button
                                onClick={() => setStep(1)}
                                className="bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 font-semibold"
                            >
                                Back
                            </button>
                            <button
                                onClick={() => setStep(3)}
                                className="bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 font-semibold"
                            >
                                Next: Review Changes
                            </button>
                        </div>
                    </div>
                );
            };

            // Step 3: Review Changes
            const Step3 = () => {
                const changes = getChanges();
                const v2Template = generateV2Template();

                return (
                    <div className="bg-white rounded-lg shadow-lg p-8 max-w-6xl mx-auto">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">Review Changes Summary</h2>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-3 gap-4 mb-6">
                            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div className="text-2xl font-bold text-green-700">{changes.added.length}</div>
                                <div className="text-sm text-green-600">New Mappings Added</div>
                            </div>
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                <div className="text-2xl font-bold text-amber-700">{changes.modified.length}</div>
                                <div className="text-sm text-amber-600">Mappings Modified</div>
                            </div>
                            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div className="text-2xl font-bold text-red-700">{changes.deleted.length}</div>
                                <div className="text-sm text-red-600">Mappings Deleted</div>
                            </div>
                        </div>

                        {/* Detailed Changes */}
                        <div className="space-y-4 mb-6">
                            {changes.added.length > 0 && (
                                <div className="border border-green-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-green-700 mb-3 flex items-center gap-2">
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clipRule="evenodd" />
                                        </svg>
                                        Added Mappings
                                    </h3>
                                    <div className="space-y-2">
                                        {changes.added.map((mapping, idx) => (
                                            <div key={idx} className="bg-green-50 p-3 rounded text-sm">
                                                <span className="font-medium">{mapping.target}</span> → {mapping.source}
                                                {mapping.description && <span className="text-gray-600 ml-2">({mapping.description})</span>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {changes.modified.length > 0 && (
                                <div className="border border-amber-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-amber-700 mb-3 flex items-center gap-2">
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                        </svg>
                                        Modified Mappings
                                    </h3>
                                    <div className="space-y-2">
                                        {changes.modified.map((change, idx) => (
                                            <div key={idx} className="bg-amber-50 p-3 rounded text-sm">
                                                <div className="text-red-600 line-through">
                                                    {change.original.target} → {change.original.source}
                                                </div>
                                                <div className="text-green-600 font-medium">
                                                    {change.updated.target} → {change.updated.source}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {changes.deleted.length > 0 && (
                                <div className="border border-red-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-red-700 mb-3 flex items-center gap-2">
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clipRule="evenodd" />
                                        </svg>
                                        Deleted Mappings
                                    </h3>
                                    <div className="space-y-2">
                                        {changes.deleted.map((mapping, idx) => (
                                            <div key={idx} className="bg-red-50 p-3 rounded text-sm line-through text-red-600">
                                                {mapping.target} → {mapping.source}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* V2 Template Preview */}
                        <div className="mb-6">
                            <h3 className="text-lg font-semibold text-gray-700 mb-2">V2 Template Preview:</h3>
                            <pre className="bg-gray-900 text-green-400 border border-gray-700 rounded p-4 text-sm overflow-x-auto custom-scrollbar max-h-96">
{v2Template}
                            </pre>
                        </div>

                        <div className="mt-6 flex justify-between">
                            <button
                                onClick={() => setStep(2)}
                                className="bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 font-semibold"
                            >
                                Back to Edit
                            </button>
                            <button
                                onClick={downloadTemplate}
                                className="bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Download V2 Template
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">
                    {/* Header */}
                    <div className="max-w-6xl mx-auto mb-8">
                        <h1 className="text-4xl font-bold text-gray-800 mb-2">FreeMarker Mapping Visual Editor</h1>
                        <p className="text-gray-600">Transform JSON ↔ JSON, XML ↔ JSON with visual mapping editor</p>
                    </div>

                    {/* Progress Steps */}
                    <div className="max-w-6xl mx-auto mb-8">
                        <div className="flex items-center justify-center">
                            {[1, 2, 3].map((stepNum) => (
                                <React.Fragment key={stepNum}>
                                    <div className="flex items-center">
                                        <div className={`flex items-center justify-center w-10 h-10 rounded-full ${step >= stepNum ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-600'} font-semibold`}>
                                            {stepNum}
                                        </div>
                                        <div className={`ml-2 text-sm font-medium ${step >= stepNum ? 'text-blue-600' : 'text-gray-500'}`}>
                                            {stepNum === 1 ? 'Upload' : stepNum === 2 ? 'Edit' : 'Review'}
                                        </div>
                                    </div>
                                    {stepNum < 3 && (
                                        <div className={`w-24 h-1 mx-4 ${step > stepNum ? 'bg-blue-600' : 'bg-gray-300'}`}></div>
                                    )}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>

                    {/* Step Content */}
                    {step === 1 && <Step1 />}
                    {step === 2 && <Step2 />}
                    {step === 3 && <Step3 />}
                </div>
            );
        }

        ReactDOM.render(<FreemarkerEditor />, document.getElementById('root'));
    </script>
</body>
</html>
